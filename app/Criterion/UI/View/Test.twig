{% extends 'Layout.twig' %}

{% block content %}

    <h1 class="lead">{{ project.repo }}
        {% if test.status.code == '1' %}
            {% set status_label = 'success' %}
        {% elseif test.status.code == '4' %}
            {% set status_label = 'info' %}
        {% elseif test.status.code == '3' %}
            {% set status_label = 'warning' %}
        {% elseif test.status.code == '0' %}
            {% set status_label = 'important' %}
        {% endif %}
        <span id="status" class="label label-{{ status_label }}">
            {{ test.status.message }}
        </span>
    </h1>

    <hr />

    <table class="table well">
        <thead>
            <tr>
                <th>Commit</th>
                <th>Author</th>
                <th>Branch</th>
                <th>Time</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td id="commit-hash">
                    ...
                </td>
                <td id="commit-author">
                    ...
                </td>
                <td id="branch">
                    ...
                </td>
                <td>
                    <span class="timeago" title="{{ test.started.sec|date('c') }}">
                        {{ test.started.sec|date('jS M Y') }}
                    </span>
                </td>
            </tr>
        </tbody>
    </table>

    <hr />

    <h1 class="lead">Logs</h1>
    <div id="logs">
        {% for item in log %}
            <div>
                <a href="javascript:void(0)" class="output-log">
                    {% if item.response == 0 %}
                        <p class="alert alert-success">{{ item.command }}</p>
                    {% else %}
                        <p class="alert alert-danger">{{ item.command }}</p>
                    {% endif %}
                </a>

                <div class="well well-small {% if item.response == 0 %} hide {% endif %}">
                    {% if item.output %}
                        {{ item.output|nl2br }}
                    {% else %}
                        There was no output from this command.
                    {% endif %}
                </div>

            </div>
        {% else %}
            <p class="alert alert-info">There are no logs for this test yet</p>
        {% endfor %}
    </div>

    <script>
        var build = setInterval(function() {
            getStatus()
        }, 1000);
        $(document).ready(function() {
            getStatus();
            $('.output-log').on('click', function(){
                $(this).next().toggle();
            });
        });

        function getStatus() {
            $.get('/test/status/{{ test._id }}', function(data) {

                if (data.status.code == '1') {
                    var status_class = 'success';
                    clearInterval(build);
                } else if (data.status.code == '3') {
                    var status_class = 'warning';
                } else {
                    var status_class = 'info';
                }

                $('#status').text(data.status.message);
                $('#status').removeClass().addClass('label').addClass('label-' + status_class);
                if (typeof data.commit != 'undefined') {
                    $('#commit-hash').text(data.commit.hash.short);
                    $('#commit-author').text(data.commit.author.name);
                    $('#branch').text(data.branch);
                }

                if (data.log.length > 0) {
                    $('#logs').html('');
                    $.each(data.log, function(key, val) {

                        if (val.response == '0') {
                            var alert = 'success';
                        } else {
                            var alert = 'alert';
                        }

                        $('#logs').append(
                        '<div>' +
                            '<a href="javascript:void(0)" class="output-log">' +
                                '<p class="alert alert-'+alert+' ">' +
                                    val.command +
                                '</p>' +
                            '</a>' +
                            '<div class="well well-small hide">' +
                                val.output +
                            '</div>' +
                        '</div>');
                    });
                }

            });
        }
    </script>

{% endblock %}
